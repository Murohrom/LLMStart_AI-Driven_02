name: ğŸš€ Deploy to Railway

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº

jobs:
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ñ‚ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾
    if: github.ref == 'refs/heads/main'
    
    environment:
      name: production
      url: https://your-app-name.railway.app
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: âš¡ Install uv
      uses: astral-sh/setup-uv@v2
      with:
        version: "latest"
    
    - name: ğŸ“¦ Install dependencies
      run: |
        uv sync
    
    - name: ğŸ§ª Run quick tests
      run: |
        uv run pytest tests/ -x --tb=short
    
    - name: ğŸ³ Build Docker image
      run: |
        docker build -t sarcastic-bot:latest .
    
    - name: ğŸ” Test Docker image
      run: |
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ğ· Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ Ğ±ĞµĞ· Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
        echo "TELEGRAM_BOT_TOKEN=test_token" > .env.test
        echo "OPENROUTER_API_KEY=test_key" >> .env.test
        timeout 5s docker run --env-file .env.test sarcastic-bot:latest || true
    
    - name: ğŸš€ Deploy to Railway
      uses: bervProject/railway-deploy@v1.3.0
      with:
        railway_token: ${{ secrets.RAILWAY_TOKEN }}
        service: ${{ secrets.RAILWAY_SERVICE_ID }}
        detach: true
    
    - name: ğŸ“ Create deployment summary
      run: |
        echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Status**: Deployed successfully" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“¦ **Version**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "ğŸŒ **Environment**: Production" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“… **Date**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— Links:" >> $GITHUB_STEP_SUMMARY
        echo "- [Railway Dashboard](https://railway.app/dashboard)" >> $GITHUB_STEP_SUMMARY
        echo "- [Application Logs](https://railway.app/project/${{ secrets.RAILWAY_PROJECT_ID }}/service/${{ secrets.RAILWAY_SERVICE_ID }})" >> $GITHUB_STEP_SUMMARY

  notify:
    name: ğŸ“¢ Notify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
    - name: ğŸ“¢ Notify success
      if: needs.deploy.result == 'success'
      run: |
        echo "ğŸ‰ Deployment successful! Bot is live and ready to spread sarcasm!"
        # Ğ—Ğ´ĞµÑÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ² Slack/Discord/Telegram
    
    - name: ğŸ“¢ Notify failure
      if: needs.deploy.result == 'failure'
      run: |
        echo "ğŸ’¥ Deployment failed! Even the deployment process couldn't handle our sarcasm."
        # Ğ—Ğ´ĞµÑÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ…
