name: ğŸ³ Docker Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Dockerfile'
      - 'docker-compose.yml'
      - 'src/**'
      - 'pyproject.toml'
  pull_request:
    branches: [ main ]
    paths:
      - 'Dockerfile'
      - 'docker-compose.yml'
      - 'src/**'
      - 'pyproject.toml'

jobs:
  docker-build:
    name: ğŸ³ Build Docker Image
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ³ Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        tags: sarcastic-bot:test
        load: true
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: ğŸ” Inspect Docker image
      run: |
        docker inspect sarcastic-bot:test
        docker history sarcastic-bot:test
    
    - name: ğŸ“Š Check image size
      run: |
        docker images sarcastic-bot:test --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"
        
        # ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ ĞµÑĞ»Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ· Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 500MB
        SIZE_MB=$(docker images sarcastic-bot:test --format "{{.Size}}" | sed 's/MB//' | cut -d. -f1)
        if [ "$SIZE_MB" -gt 500 ]; then
          echo "âš ï¸ Warning: Docker image is quite large ($SIZE_MB MB)"
          echo "Consider optimizing the Dockerfile for production"
        else
          echo "âœ… Docker image size is acceptable: $SIZE_MB MB"
        fi

  docker-test:
    name: ğŸ§ª Test Docker Container
    runs-on: ubuntu-latest
    needs: docker-build
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ³ Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        tags: sarcastic-bot:test
        load: true
        cache-from: type=gha
    
    - name: ğŸ”§ Create test environment file
      run: |
        cat > .env.test << EOF
        TELEGRAM_BOT_TOKEN=test_token_for_ci
        OPENROUTER_API_KEY=test_api_key_for_ci
        OPENROUTER_MODEL=test/model
        LLM_TIMEOUT=5
        LLM_TEMPERATURE=0.8
        LLM_RETRY_ATTEMPTS=1
        LOG_LEVEL=INFO
        LOG_FILE=logs/bot.log
        DEBUG=false
        EOF
    
    - name: ğŸ§ª Test container startup
      run: |
        echo "ğŸš€ Testing container startup..."
        
        # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ² Ñ„Ğ¾Ğ½Ğµ
        docker run -d --name test-bot --env-file .env.test sarcastic-bot:test
        
        # Ğ–Ğ´ĞµĞ¼ 10 ÑĞµĞºÑƒĞ½Ğ´ Ğ´Ğ»Ñ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
        echo "â³ Waiting for container to initialize..."
        sleep 10
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ²ÑĞµ ĞµÑ‰Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚
        if docker ps | grep test-bot; then
          echo "âœ… Container is running successfully"
        else
          echo "âŒ Container failed to start or crashed"
          docker logs test-bot
          exit 1
        fi
        
        # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€
        docker stop test-bot
        docker rm test-bot
    
    - name: ğŸ§ª Test container logs
      run: |
        echo "ğŸ“ Testing container logging..."
        
        # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ»Ğ¾Ğ³Ğ¸
        docker run -d --name test-logs --env-file .env.test sarcastic-bot:test
        sleep 5
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ»Ğ¾Ğ³Ğ¸
        LOGS=$(docker logs test-logs 2>&1)
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ² Ğ»Ğ¾Ğ³Ğ°Ñ… ĞµÑÑ‚ÑŒ Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
        if echo "$LOGS" | grep -i "starting"; then
          echo "âœ… Found startup messages in logs"
        else
          echo "âš ï¸ No startup messages found in logs"
          echo "Logs content:"
          echo "$LOGS"
        fi
        
        # ĞÑ‡Ğ¸ÑÑ‚ĞºĞ°
        docker stop test-logs
        docker rm test-logs
    
    - name: ğŸ§ª Test container with docker-compose
      run: |
        echo "ğŸ³ Testing with docker-compose..."
        
        # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ env Ñ„Ğ°Ğ¹Ğ»
        cp .env.test .env
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ docker-compose Ñ„Ğ°Ğ¹Ğ» Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¹
        docker-compose config
        
        # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞµÑ€Ğ²Ğ¸Ñ
        docker-compose up -d
        
        # Ğ–Ğ´ĞµĞ¼ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
        sleep 10
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
        if docker-compose ps | grep "Up"; then
          echo "âœ… Docker Compose service is running"
        else
          echo "âŒ Docker Compose service failed"
          docker-compose logs
          exit 1
        fi
        
        # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼
        docker-compose down
    
    - name: ğŸ”§ Test container environment variables
      run: |
        echo "ğŸ” Testing environment variable handling..."
        
        # Ğ¢ĞµÑÑ‚ Ñ Ğ½ĞµĞ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¼Ğ¸ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ (Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑƒĞ¿Ğ°ÑÑ‚ÑŒ)
        echo "TELEGRAM_BOT_TOKEN=" > .env.incomplete
        
        if docker run --env-file .env.incomplete sarcastic-bot:test 2>&1 | grep -i "required"; then
          echo "âœ… Container correctly validates required environment variables"
        else
          echo "âš ï¸ Container should validate required environment variables"
        fi

  docker-security:
    name: ğŸ”’ Docker Security Scan
    runs-on: ubuntu-latest
    needs: docker-build
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ³ Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        tags: sarcastic-bot:security-test
        load: true
        cache-from: type=gha
    
    - name: ğŸ”’ Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'sarcastic-bot:security-test'
        format: 'sarif'
        output: 'trivy-results.sarif'
        exit-code: '0'  # ĞĞµ Ğ¿Ñ€ĞµÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ CI Ğ½Ğ° ÑƒÑĞ·Ğ²Ğ¸Ğ¼Ğ¾ÑÑ‚ÑÑ… Ğ² MVP
    
    - name: ğŸ“Š Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
